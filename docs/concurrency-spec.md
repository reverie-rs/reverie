Reverie Concurrency Model
=========================

An instrumentation tool based on Reverie (henceforth "tool"),
intercepts events from one or more *guest* threads.  The guest process
begins at a single root, but may fork any number of threads and
processes, all of which are instrumented by the tool. The tool
registers handlers for processing events generated by the guest.

Per-thread sequentiality
------------------------

The originating thread for any event is paused while its handler
begins running.  The handler `H` is explicitly associated with the
thread ID of the guest, `T`.  Each thread ID may have at most one
handler running at any time. Handlers are not reentrant.

Handlers are *not*, however, atomic.  While the handler is running, it
may inject syscalls or other code back into the guest.  These
constitute context switches between the handler and the originating
guest thread.

Each handler execution is finite (and should be bounded). Each such
execution consists of a series of critical sections during which the
handler is computing before returning control.  The handler can yield
in the middle of its execution in two ways:

 * Injecting function or system calls in the guest.
 * Sending an RPC to the tool's global state object.

In either case, the engine running the handler may need to be able to
store its continuation while it is waiting for the handler to become
runnable again.  In this way, the handler is much like a lightweight
thread.

Handler concurrency
-------------------

Because of their non-atomic, yielding nature, multiple handlers may be
running concurrently, corresponding to the multiple threads of the
guest.  When a handler yields in the two ways listed above, another
handler from another thread may execute for a time slice in its stead.

Interleaving handlers is necessary, because in some cases the handler
waits on an (injected) blocking system call in the guest, which in
turn may require progress in other threads to progress.  "Progress in
other threads" may in turn require that those threads be able to
dispatch handlers.
